<!DOCTYPE html>
<html lang="en" data-ix-theme="classic" data-ix-color-schema="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WinCC Open Architecture - Project manager</title>
    <link rel="stylesheet" href="/project/css/style.css">
    <script src="/project/js/app.js" defer></script>
</head>
<body>
    <div class="header">
        <!-- WinCC OA Logo SVG -->
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 219.9 219.9">
            <style>
                .cls-1 { fill: #01656e; }
                .cls-2 { fill: #ffd732; }
                .cls-3 { fill: #00557c; }
                .cls-4 { fill: #1fb9d8; }
            </style>
            <g id="winccoa">
                <rect class="cls-4" width="50.1" height="50.1"/>
                <rect class="cls-3" x="56.6" width="50.1" height="50.1"/>
                <rect class="cls-1" x="113.2" width="50.1" height="50.1"/>
                <rect class="cls-4" x="169.8" width="50.1" height="50.1"/>
                <rect class="cls-3" y="56.6" width="50.1" height="50.1"/>
                <rect class="cls-2" x="56.6" y="56.6" width="50.1" height="50.1"/>
                <rect class="cls-4" x="113.2" y="56.6" width="50.1" height="50.1"/>
                <rect class="cls-2" x="169.8" y="56.6" width="50.1" height="50.1"/>
                <rect class="cls-2" y="113.2" width="50.1" height="50.1"/>
                <rect class="cls-1" x="56.6" y="113.2" width="50.1" height="50.1"/>
                <rect class="cls-3" x="113.2" y="113.2" width="50.1" height="50.1"/>
                <rect class="cls-1" x="169.8" y="113.2" width="50.1" height="50.1"/>
                <rect class="cls-3" y="169.8" width="50.1" height="50.1"/>
                <rect class="cls-2" x="56.6" y="169.8" width="50.1" height="50.1"/>
                <rect class="cls-1" x="113.2" y="169.8" width="50.1" height="50.1"/>
                <rect class="cls-4" x="169.8" y="169.8" width="50.1" height="50.1"/>
            </g>
        </svg>
        <h1>WinCC Open Architecture â€“ Project manager</h1>
        <!-- WebSocket Connection Status -->
        <div id="wsStatus" class="ws-status" title="WebSocket disconnected">
            <span class="ws-indicator disconnected"></span>
            <span class="ws-label">Offline</span>
        </div>
        <!-- Dark Mode Toggle -->
        <button id="darkModeToggle" class="dark-mode-toggle" onclick="toggleDarkMode()" title="Toggle dark mode">
            <span class="icon-sun">&#9788;</span>
            <span class="icon-moon">&#9790;</span>
        </button>
    </div>

    <div class="main-container">
        <!-- Tab Navigation -->
        <ul class="tab-menu">
            <li class="tab-link active" onclick="openTab(event, 'Download')">Download</li>
            <li class="tab-link" onclick="openTab(event, 'History')">History</li>
            <li class="tab-link" onclick="openTab(event, 'Status')">Console</li>
            <li class="tab-link" onclick="openTab(event, 'Logs')">Log Viewer</li>
        </ul>

        <!-- Download Tab -->
        <div class="tab-content active" id="Download">
            <div class="form-wrapper">
                <div class="form-box">
                    <h2>Download Your Project</h2>
                    <form id="downloadForm" onsubmit="handleDownload(event)" enctype="multipart/form-data">
                        <!-- CSRF Token (hidden, populated by JavaScript) -->
                        <input type="hidden" name="csrfToken" id="csrfToken" value="">

                        <label for="dateiupload">Select ZIP file:</label>
                        <input type="file" name="dateiupload" accept=".zip" required>

                        <label>
                            <input type="checkbox" name="restartProject" id="restartProject" value="true" onchange="toggleNotice()">
                            Restart project after download
                        </label>

                        <div id="restartNotice" class="warning-notice">
                            <strong>Warning:</strong> This will restart <u>ALL managers</u> after project downloaded to WinCC OA server(s). This may cause loss of production.
                        </div>

                        <input type="submit" value="Download">
                    </form>

                    <!-- Upload Progress Bar -->
                    <div id="uploadProgressContainer" class="upload-progress-container" style="display: none;">
                        <div class="upload-progress-header">
                            <div class="upload-file-info">
                                <span id="uploadFileName">-</span>
                                <span id="uploadFileSize" class="upload-file-size">-</span>
                            </div>
                            <button type="button" id="uploadCancelBtn" onclick="cancelUpload()" class="btn-cancel" title="Cancel upload">&#10005;</button>
                        </div>
                        <div class="upload-progress-status">
                            <span id="uploadProgressText">Starting...</span>
                            <span id="uploadProgressPercent">0%</span>
                        </div>
                        <div class="upload-progress-track">
                            <div id="uploadProgressBar" class="upload-progress-fill" style="width: 0%;"></div>
                        </div>
                    </div>

                    <!-- Confirmation Modal -->
                    <div id="confirmationModal" class="modal-overlay">
                        <div class="modal-content">
                            <h3>Restart of project</h3>
                            <p>You have requested to restart the project.<br><strong>All managers will be restarted after download.</strong><br>Do you wish to continue?</p>
                            <button class="primary" onclick="confirmDownload(true)">Yes, continue</button>
                            <button onclick="confirmDownload(false)">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- History Tab -->
        <div class="tab-content" id="History">
            <div class="form-wrapper">
                <div class="form-box" style="max-width: 95% !important;">
                    <h2>Deployment History</h2>

                    <!-- History Toolbar -->
                    <div class="history-toolbar">
                        <div class="toolbar-left">
                            <input type="button" onclick="refreshHistory()" value="Refresh" class="btn-toolbar">
                            <input type="button" onclick="exportHistoryCSV()" value="Export CSV" class="btn-toolbar btn-secondary">
                            <input type="text" id="historySearch" placeholder="Search..." oninput="filterHistory()">
                            <select id="historyStatusFilter" onchange="filterHistory()">
                                <option value="">All status</option>
                                <option value="success">Success</option>
                                <option value="failed">Failed</option>
                            </select>
                        </div>
                        <div class="toolbar-right">
                            <span id="historyCount">0 deployments</span>
                        </div>
                    </div>

                    <!-- History Table -->
                    <div class="history-container">
                        <table id="historyTable">
                            <thead>
                                <tr>
                                    <th>Date/Time</th>
                                    <th>File Name</th>
                                    <th>Size</th>
                                    <th>User</th>
                                    <th>Host</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody">
                                <tr>
                                    <td colspan="6" class="history-empty">No deployment history available</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Console Tab -->
        <div class="tab-content" id="Status">
            <div class="form-wrapper">
                <div class="form-box" style="max-width: 95% !important;">
                    <!-- Console Toolbar -->
                    <div class="console-toolbar">
                        <div class="toolbar-left">
                            <input type="button" onclick="refreshStatus()" value="Refresh" class="btn-toolbar">
                            <input type="button" onclick="restartProject()" value="Restart" class="btn-toolbar btn-danger">
                        </div>
                        <div class="toolbar-right">
                            <div class="last-refresh">
                                Last update: <span id="lastRefreshTime">--:--:--</span>
                            </div>
                        </div>
                    </div>

                    <div id="instanceTabsContainer"></div>
                    <div id="instanceContentContainer"></div>
                </div>
            </div>
        </div>

        <!-- Log Viewer Tab -->
        <div class="tab-content" id="Logs">
            <div class="form-wrapper">
                <div class="form-box" style="max-width: 95% !important;">
                    <h2>Log Viewer</h2>

                    <!-- Log Viewer Toolbar -->
                    <div class="log-toolbar">
                        <div class="toolbar-left">
                            <label for="logFileSelect">File:</label>
                            <select id="logFileSelect" onchange="selectLogFile()">
                                <option value="">-- Select a log file --</option>
                            </select>
                            <input type="button" onclick="refreshLogFiles()" value="Refresh List" class="btn-toolbar">
                        </div>
                        <div class="toolbar-right">
                            <label><input type="text" id="logFilterInput" placeholder="Search..."></label>
                            <label><input type="checkbox" id="logPauseScroll"> Pause scroll</label>
                            <label><input type="checkbox" id="logFreezeUpdate"> Freeze</label>
                        </div>
                    </div>

                    <!-- Log Container -->
                    <div id="logContainer" class="log-container">Select a log file to view...</div>

                    <!-- Link to standalone viewer -->
                    <div class="log-footer">
                        <a href="/logs" target="_blank">Open standalone log viewer</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Server Availability Modal -->
    <div id="serverModal" style="display:none;">
        <div>
            <p>Please wait while we try to reach the server...</p>
        </div>
    </div>

    <!-- ZIP Preview Modal -->
    <div id="zipPreviewModal" class="modal-overlay">
        <div class="modal-content modal-large">
            <h3>ZIP Contents Preview</h3>
            <div class="zip-preview-info">
                <span id="zipFileName">-</span>
                <span id="zipFileSize">-</span>
                <span id="zipFileCount">0 files</span>
            </div>
            <div class="zip-preview-container">
                <table id="zipPreviewTable">
                    <thead>
                        <tr>
                            <th>File Path</th>
                            <th>Size</th>
                        </tr>
                    </thead>
                    <tbody id="zipPreviewBody">
                    </tbody>
                </table>
            </div>
            <div class="modal-actions">
                <button class="primary" onclick="confirmZipUpload()">Deploy</button>
                <button onclick="closeZipPreview()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>
</body>
</html>
